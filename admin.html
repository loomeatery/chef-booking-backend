<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Chef Admin</title>
  <style>
    :root{
      --ink:#183027;
      --mut:#6b7a71;
      --bg:#f6f7f5;
      --card:#ffffff;
      --green:#2e7d32;
      --green-2:#1b5e20;
      --btn:#2f6f4f;
      --pill:#e9f5ee;
      --red:#e53935;
      --red-2:#b71c1c;
      --border:#e6ebe8;
      --ring:rgba(46,125,50,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .top{background:#2e7d32;color:#fff;padding:14px 16px;display:flex;align-items:center;gap:12px}
    .brand{font-weight:800;letter-spacing:.3px}
    .top .row{margin-left:auto;display:flex;gap:8px;align-items:center}
    .key{width:280px;max-width:48vw;border:none;border-radius:10px;padding:10px 12px}
    .btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;background:#ffffff20;color:#fff}
    .btn:hover{background:#ffffff33}
    .btn.alt{background:#eef3ef;color:#234; border:1px solid var(--border)}
    .btn.alt:hover{background:#e6efe8}
    .btn.red{background:var(--red);color:#fff}
    .btn.red:hover{background:var(--red-2)}
    .wrap{max-width:1080px;margin:20px auto;padding:0 14px}
    .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    select{appearance:none;border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:#fff}
    .grid{display:grid;grid-template-columns:1.2fr .9fr;gap:16px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
    .h{font-weight:800;margin:0 0 4px}
    .mut{color:var(--mut)}
    .empty{color:var(--mut);padding:10px 0}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:top}
    th{font-size:12px;text-transform:uppercase;letter-spacing:.4px;color:#4a5a52;text-align:left}
    td.right{text-align:right}
    .pill{display:inline-block;background:var(--pill);color:var(--green-2);padding:4px 8px;border-radius:999px;border:1px solid #dcefe3;font-size:12px;font-weight:700}
    .rowline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type="date"], input[type="text"]{border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    .section-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .hint{font-size:12px;color:var(--mut)}
  </style>
</head>
<body>
  <div class="top">
    <div class="brand">Chef Admin</div>
    <div class="row">
      <input id="adminkey" class="key" type="password" placeholder="Admin key…">
      <button id="savekey" class="btn">Save</button>
      <button id="clearkey" class="btn">Clear</button>
    </div>
  </div>

  <div class="wrap">
    <div class="controls">
      <label>Month
        <select id="monthSel"></select>
      </label>
      <label>Year
        <select id="yearSel"></select>
      </label>
      <button id="refreshBtn" class="btn alt" style="color:#fff;background:var(--btn)">Refresh</button>
    </div>

    <div class="grid">
      <!-- Bookings -->
      <div class="card">
        <div class="section-head">
          <div>
            <h3 class="h">Bookings</h3>
            <div class="mut">Confirmed bookings for the selected month.</div>
          </div>
          <div class="rowline">
            <button id="exportCsv" class="btn alt">Export CSV</button>
          </div>
        </div>
        <div id="bookingsWrap" class="mut">Loading…</div>
      </div>

      <!-- Blackouts -->
      <div class="card">
        <div class="section-head">
          <div>
            <h3 class="h">Blackout Dates</h3>
            <div class="mut">Manage dates you’re unavailable.</div>
          </div>
        </div>

        <div class="rowline" style="margin-bottom:8px">
          <input type="date" id="boDate">
          <input type="text" id="boReason" placeholder="Reason (optional)">
          <button id="boAdd" class="btn alt">Add blackout</button>
        </div>

        <div class="rowline" style="margin-bottom:12px">
          <input type="text" id="boBulk" placeholder="Bulk add: YYYY-MM-DD,YYYY-MM-DD,YY">
          <button id="boBulkBtn" class="btn alt">Add bulk</button>
        </div>

        <div id="blackoutsWrap" class="mut">Loading…</div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const BASE = location.origin; // same origin as backend
    const keyInput = document.getElementById('adminkey');

    function headers(){
      const k = localStorage.getItem('ADMIN_KEY') || '';
      return { 'Content-Type':'application/json', 'X-Admin-Key': k };
    }
    async function fetchJson(url, opts={}){
      const r = await fetch(url, { ...opts, headers: { ...(opts.headers||{}), ...headers() }});
      try{ return await r.json(); }catch{ return null; }
    }
    function usd(cents){ return (Number(cents||0)/100).toLocaleString('en-US',{style:'currency',currency:'USD'}); }

    // *** UTC-SAFE DATE FORMATTER (fixes off-by-one) ***
    function fmtDate(iso){
      // iso looks like "2025-12-06T00:00:00.000Z"
      if (!iso) return '';
      const [y,m,d] = iso.slice(0,10).split('-'); // use UTC date only
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      return `${months[Number(m)-1]} ${Number(d)}, ${y}`;
    }

    function safe(s){ return (s ?? '').toString().trim(); }

    // ===== TOP BAR KEY =====
    (function initAdminKey(){
      const saved = localStorage.getItem('ADMIN_KEY') || '';
      if(saved) keyInput.value = saved;
      document.getElementById('savekey').onclick = ()=>{
        localStorage.setItem('ADMIN_KEY', keyInput.value || '');
        alert('Key saved'); loadAll();
      };
      document.getElementById('clearkey').onclick = ()=>{
        localStorage.removeItem('ADMIN_KEY'); keyInput.value='';
        alert('Key cleared'); loadAll();
      };
    })();

    // ===== MONTH / YEAR =====
    const monthSel = document.getElementById('monthSel');
    const yearSel  = document.getElementById('yearSel');
    (function initMY(){
      const months = [
        "January","February","March","April","May","June",
        "July","August","September","October","November","December"
      ];
      months.forEach((m,i)=>{ const o=document.createElement('option'); o.value=String(i+1).padStart(2,'0'); o.textContent=m; monthSel.appendChild(o); });
      const y = new Date().getFullYear();
      for(let yr=y-1; yr<=y+2; yr++){ const o=document.createElement('option'); o.value=yr; o.textContent=yr; yearSel.appendChild(o); }
      const now=new Date(); monthSel.value=String(now.getMonth()+1).padStart(2,'0'); yearSel.value=String(now.getFullYear());
    })();
    document.getElementById('refreshBtn').onclick = () => loadAll();

    // ===== BOOKINGS =====
    async function loadBookings(){
      const y = yearSel.value, m = monthSel.value;
      const data = await fetchJson(`${BASE}/__admin/list-bookings?year=${y}&month=${m}`);
      const el = document.getElementById("bookingsWrap");
      if (!Array.isArray(data) || data.length===0){
        el.innerHTML = `<div class="empty">No bookings this month.</div>`;
        return;
      }

      function yesNoPill(v,label){ return v ? `<span class="pill" style="margin-right:6px">${label}</span>` : ""; }
      function fmtAddr(b){
        const p = [
          safe(b.address_line1 || b.address1),
          [safe(b.city), safe(b.state), safe(b.zip)].filter(Boolean).join(", ")
        ].filter(Boolean);
        return p.join("<br>");
      }

      const rows = data.map((b,i)=>{
        const day   = fmtDate(b.start_at);   // <-- use UTC-sliced formatter
        const name  = safe(b.customer_name) || "—";
        const email = safe(b.customer_email) || "—";
        const pkg   = safe(b.package_title) || "—";
        const guests= b.guests ?? "—";
        const dep   = usd(b.deposit_cents);
        theStatus   = safe(b.status) || "—";
        const status= theStatus;
        const addons= `${yesNoPill(b.bartender,"Bartender")}${yesNoPill(b.tablescape,"Tablescape")}`;
        const addr  = fmtAddr(b);
        const phone = safe(b.phone);
        const diet  = safe(b.diet_notes);
        const sub   = usd(b.subtotal_cents);
        const bal   = usd(b.balance_cents);
        const rowId = `bkrow-${i}`;

        return `
          <tr>
            <td>${day}</td>
            <td>
              <div>${name}</div>
              <div class="mut" style="font-size:12px">${email}</div>
            </td>
            <td>${pkg}</td>
            <td>${guests}</td>
            <td>${addons || "—"}</td>
            <td>${dep}</td>
            <td><span class="pill">${status}</span></td>
            <td class="right">
              <button class="btn alt" data-toggle="${rowId}">View</button>
              <button class="btn alt" data-del-booking="${b.id}" style="margin-left:6px">Delete</button>
            </td>
          </tr>
          <tr id="${rowId}" style="display:none;background:#fafdfb">
            <td colspan="8">
              <div style="display:grid;grid-template-columns:1.2fr 1fr;gap:12px">
                <div>
                  <div class="mut" style="margin-bottom:6px">Address</div>
                  <div>${addr || "—"}</div>
                  <div class="mut" style="margin-top:10px">Phone</div>
                  <div>${phone || "—"}</div>
                  <div class="mut" style="margin-top:10px">Diet notes</div>
                  <div style="white-space:pre-wrap">${diet || "—"}</div>
                </div>
                <div>
                  <div class="mut" style="margin-bottom:6px">Amounts</div>
                  <div>Subtotal: <strong>${sub}</strong></div>
                  <div>Deposit: <strong>${dep}</strong></div>
                  <div>Balance: <strong>${bal}</strong></div>
                </div>
              </div>
            </td>
          </tr>
        `;
      }).join("");

      el.innerHTML = `
        <table>
          <thead><tr>
            <th>Date</th><th>Customer</th><th>Package</th>
            <th>Guests</th><th>Add-ons</th><th>Deposit</th><th>Status</th><th></th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      // Toggle details
      el.querySelectorAll("[data-toggle]").forEach(btn=>{
        btn.onclick = () => {
          const id = btn.getAttribute("data-toggle");
          const row = document.getElementById(id);
          row.style.display = row.style.display === "none" ? "" : "none";
          btn.textContent = row.style.display === "none" ? "View" : "Hide";
        };
      });

      // Delete booking (use for test rows only)
      el.querySelectorAll("[data-del-booking]").forEach(btn=>{
        btn.onclick = async () => {
          if (!confirm("Delete this booking? (Use for test rows only)")) return;
          const id = btn.getAttribute("data-del-booking");
          const r = await fetch(`${BASE}/api/admin/bookings/${id}`,{
            method:"DELETE", headers: headers()
          });
          if (!r.ok) { alert("Delete failed"); return; }
          loadBookings();
        };
      });
    }

    // CSV export (confirmed + pending shown)
    document.getElementById('exportCsv').onclick = async () => {
      const y=yearSel.value,m=monthSel.value;
      const data = await fetchJson(`${BASE}/__admin/list-bookings?year=${y}&month=${m}`);
      if (!Array.isArray(data) || data.length===0){ alert("No data"); return; }
      const cols = [
        'id','start_at','status','customer_name','customer_email',
        'package_title','guests','phone','address_line1','city','state','zip',
        'diet_notes','bartender','tablescape','subtotal_cents','deposit_cents','balance_cents'
      ];
      const esc = v => `"${String(v??'').replace(/"/g,'""')}"`;
      const rows = [cols.join(',')]
        .concat(data.map(r=>cols.map(c=>esc(r[c])).join(',')))
        .join('\n');
      const blob = new Blob([rows],{type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `bookings-${y}-${m}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    };

    // ===== BLACKOUTS =====
    async function loadBlackouts(){
      const y = yearSel.value, m = monthSel.value;
      const data = await fetchJson(`${BASE}/__admin/list-blackouts?year=${y}&month=${m}`);
      const el = document.getElementById("blackoutsWrap");
      if (!Array.isArray(data) || data.length===0){
        el.innerHTML = `<div class="empty">No blackouts this month.</div>`;
        return;
      }
      const rows = data.map(b=>{
        const day = fmtDate(b.start_at);    // <-- use UTC-sliced formatter
        const reason = safe(b.reason) || "—";
        return `
          <tr>
            <td>${day}</td>
            <td>${reason}</td>
            <td class="right"><button class="btn red" data-del="${b.id}">Delete</button></td>
          </tr>
        `;
      }).join("");
      el.innerHTML = `
        <table>
          <thead><tr><th>Date</th><th>Reason</th><th></th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      `;
      el.querySelectorAll("[data-del]").forEach(btn=>{
        btn.onclick = async () => {
          if (!confirm("Delete this blackout date?")) return;
          const id = btn.getAttribute("data-del");
          const r = await fetch(`${BASE}/api/admin/blackouts/${id}`,{
            method:"DELETE", headers: headers()
          });
          if (!r.ok){ alert("Delete failed"); return; }
          loadBlackouts();
        };
      });
    }

    // Add blackout
    document.getElementById('boAdd').onclick = async () => {
      const d = document.getElementById('boDate').value;
      const reason = document.getElementById('boReason').value.trim();
      if(!d){ alert("Pick a date"); return; }
      const r = await fetch(`${BASE}/api/admin/blackouts`,{
        method:"POST",
        headers: headers(),
        body: JSON.stringify({ date:d, reason })
      });
      if(!r.ok){ alert("Add failed"); return; }
      document.getElementById('boDate').value = "";
      document.getElementById('boReason').value = "";
      loadBlackouts();
    };

    // Bulk add blackout
    document.getElementById('boBulkBtn').onclick = async () => {
      const raw = document.getElementById('boBulk').value.trim();
      if(!raw){ alert("Enter dates like 2025-10-12,2025-10-13"); return; }
      const dates = raw.split(',').map(s=>s.trim()).filter(Boolean);
      const reason = document.getElementById('boReason').value.trim();
      const r = await fetch(`${BASE}/api/admin/blackouts/bulk`,{
        method:"POST",
        headers: headers(),
        body: JSON.stringify({ dates, reason })
      });
      if(!r.ok){ alert("Bulk add failed"); return; }
      document.getElementById('boBulk').value="";
      loadBlackouts();
    };

    async function loadAll(){ await Promise.all([loadBookings(), loadBlackouts()]); }
    // initial
    loadAll();
  </script>
</body>
</html>
